<!DOCTYPE html>
<!-- from http://bl.ocks.org/mbostock/4339083
and http://bl.ocks.org/mbostock/4063550

!-->
<html>
<head>
<meta charset="utf-8">
<style>
.timelinepoint {
  font-size: 12px;
}

.eebevent {
  font-size: 14px;
}
.eebclass {
  font-size: 14px;
}

</style>
</head>
<body>
<script src="d3/d3.v3.min.js"></script>
<script src="jquery/jquery.v2.min.js"></script>
<script src="./data.js"> </script>
<p id="help"></p>
<div>
  <div id="canvas"/>
</div>

<script>
////////////////////////////////////////////////////////////////////////
// HARD-CODED CONSTANTS
var CANVAS_WIDTH = 1200;
var CANVAS_HEIGHT = 520;

var TIMELINE_X = 5;
var TIMELINE_Y = 5;
var TL_TEXT_PUSH_Y = 10;
var TIMELINE_WIDTH = 100;
var TIMELINE_TEXT_WIDTH = TIMELINE_WIDTH - 10;
var MID_TIMELINE_X = TIMELINE_X  + (TIMELINE_WIDTH/2);

var EEB_X = TIMELINE_X + TIMELINE_WIDTH + 40;
var EEB_Y = TIMELINE_Y;
var EEB_TEXT_PUSH_Y = TL_TEXT_PUSH_Y;
var EEB_WIDTH = 120;
var EEB_TEXT_WIDTH = EEB_WIDTH - 10;
var MID_EEB_X = EEB_X  + (EEB_WIDTH/2);

var CLASS_WIDTH = 2* EEB_WIDTH;
var CLASS_X = EEB_X + (EEB_WIDTH + CLASS_WIDTH)/2 + 40;
var CLASS_Y = EEB_Y;
var CLASS_TEXT_PUSH_Y = EEB_TEXT_PUSH_Y;
var CLASS_TEXT_WIDTH = CLASS_WIDTH - 10;
var MID_CLASS_X = CLASS_X  + (CLASS_WIDTH/2);

var FIRST_MONTH_Y = TIMELINE_Y + 20;
var FIRST_SEMESTER_Y = FIRST_MONTH_Y + 20;
var SEM_GAP_Y = 50;
var FIRST_FALL_Y = FIRST_SEMESTER_Y;
var FIRST_SPRING_Y = FIRST_FALL_Y + SEM_GAP_Y;
var THIRD_SEM_Y = FIRST_SPRING_Y + SEM_GAP_Y;
var START_THIRD_SEMESTER_Y = THIRD_SEM_Y - 40;
var BEFORE_ORALS_Y = THIRD_SEM_Y - 20;
var CANDIDACY_Y = THIRD_SEM_Y + 15;
var FOURTH_SEM_Y = THIRD_SEM_Y + SEM_GAP_Y;
var EARLY_FOURTH_SEMESTER_Y = FOURTH_SEM_Y - 20;
var AFTER_CANDIDACY_Y = FOURTH_SEM_Y + 25;
var THIRD_YEAR_Y = FOURTH_SEM_Y + SEM_GAP_Y;
var FOURTH_YEAR_Y = THIRD_YEAR_Y + 2*SEM_GAP_Y;
var EARLY_FIFTH_SEMESTER_Y = THIRD_YEAR_Y - 20;
var DEFENSE_Y = CANVAS_HEIGHT - 20;
var BEFORE_DEFENSE_Y = DEFENSE_Y - 20;
///////////////////////////////////////////////////////////////////////////

var class_by_sem = [];

function isInteger(value) {
  return /^\d+$/.test(value);
}


var parse_timing = function(ts) {
  var name_to_num = {
    "AFTER_CANDIDACY": AFTER_CANDIDACY_Y,
    "BEFORE_ORALS": BEFORE_ORALS_Y,
    "DEFENSE_DATE": DEFENSE_Y,
    "FIFTH_SEMESTER": THIRD_YEAR_Y,
    "FIRST_FALL": FIRST_FALL_Y,
    "FIRST_MONTH": FIRST_MONTH_Y,
    "FIRST_SPRING": FIRST_SPRING_Y,
    "FOURTH_SEMESTER": FOURTH_SEM_Y,
    "THIRD_SEMESTER": THIRD_SEM_Y,
    "START_THIRD_SEMESTER": START_THIRD_SEMESTER_Y,
    "EARLY_FOURTH_SEMESTER": EARLY_FOURTH_SEMESTER_Y,
    "EARLY_FIFTH_SEMESTER": EARLY_FIFTH_SEMESTER_Y,
    "BEFORE_DEFENSE_DATE": BEFORE_DEFENSE_Y,
  }
  if (isInteger(ts)) {
    return parseInt(ts, 10);
  }
  if (ts in name_to_num) {
    return name_to_num[ts];
  }
  throw new Error("Key " + ts + " not recognized as a time.");
}
var non_class_events = [];
var classes = [];
var do_parse_all_data = function(event_list) {
  non_class_events.length = 0;
  classes.length = 0;
  var unc_el;
  for (unc_el of event_list) {
    if (unc_el.timing) {
      unc_el.timing = parse_timing(unc_el.timing)
    }
    if (unc_el.type == "class") {
      classes[classes.length] = unc_el;
    } else if (unc_el.type == "event") {
      non_class_events[non_class_events.length] = unc_el;
    } else {
      throw new Error("event/class object type should be class or event")
    }
  }
};

var timeline_y = [FIRST_MONTH_Y, FIRST_FALL_Y, FIRST_SPRING_Y, THIRD_SEM_Y, FOURTH_SEM_Y];
var timeline_objs = [{
    "time_offset": 0,
    "text": "1st month"
  }, {
    "time_offset": 1,
    "text": "1st Fall"
  }, {
    "time_offset": 2,
    "text": "1st Spring"
  }, {
    "time_offset": 3,
    "text": "3rd Semester"
  },{
    "time_offset": 4,
    "text": "4th Semester"
  }
];




var canvas_root = d3.select('#canvas').append('svg')
    .attr({'width':  CANVAS_WIDTH,
           'height': CANVAS_HEIGHT,})
    .style('background', 'white');

// var g_el = canvas_root.selectAll('g')
//   .enter()
//   .append('g');

var add_timeline_text = function(y, text_val) {
  canvas_root.append('text')
    .attr({"x": MID_TIMELINE_X,
           "y":  y + TL_TEXT_PUSH_Y,
           "class":"timelinepoint"})
    .text(text_val).attr({"text-anchor": "middle"});
};

var add_timeline_obj = function(o) {
  var y_var = timeline_y[o.time_offset];
  add_timeline_text(y_var, o.text);
  // add_timeline_text(FIRST_MONTH_Y, "1st month");
  // add_timeline_text(FIRST_FALL_Y, "1st Fall");
  // add_timeline_text(FIRST_SPRING_Y, "1st Spring");
  // add_timeline_text(THIRD_SEM_Y, "3rd Semester");
  // add_timeline_text(FOURTH_SEM_Y, "4th Semester");
  //add_timeline_text(FIRST_FALL_Y, "1st Fall");
};
var do_draw_timeline = function() {
  canvas_root.append("rect")
    .attr({'x': TIMELINE_X, 'y': TIMELINE_Y,
           'height': CANDIDACY_Y - TIMELINE_Y,
           'width': TIMELINE_WIDTH,
           'fill': "white", 'stroke': "black"});
  canvas_root.append('text')
    .attr({"x":MID_TIMELINE_X, "y": TIMELINE_Y + 15,
           "font-size":"10pt", "fill": "grey",
           "text-anchor": "middle"})
    .text("pre-candidacy");
  canvas_root.append("rect")
    .attr({'x': TIMELINE_X, 'y': CANDIDACY_Y,
           'height': DEFENSE_Y - CANDIDACY_Y,
           'width': TIMELINE_WIDTH,
           'fill': "white", 'stroke': "black"});
  canvas_root.append('text')
    .attr({"x": MID_TIMELINE_X, "y": DEFENSE_Y - 15,
           "font-size":"10pt", "fill": "grey",
           "text-anchor": "middle"})
    .text("candidacy");
  var o;
  for (o of timeline_objs) {
    add_timeline_obj(o);
  }
};

var add_eeb_text = function(y, text_val, lg_vec) {
  canvas_root.append('text')
    .attr({"x": MID_EEB_X,
           "y":  y + EEB_TEXT_PUSH_Y,
           "class":"eebevent"})
    .text(text_val).attr({"text-anchor": "middle"});
};

var add_eeb_obj = function(o) {
  add_eeb_text(o.timing, o.title, o.outcomes);
}

var do_draw_eeb_events = function() {
  canvas_root.append('text')
    .attr({"x":MID_EEB_X, "y": EEB_Y + 15,
           "font-size":"10pt", "fill": "grey",
           "text-anchor": "middle"})
    .text("EEB non-class events");

  var o;
  for (o of non_class_events) {
    if (o.timing !== undefined) {
      add_eeb_obj(o);
    }
  }
}


var add_class_obj = function(o) {
  var semester_num = o.timing;
  while (semester_num >= class_by_sem.length) {
    class_by_sem[class_by_sem.length] = [];
  }
  var rel_sem = class_by_sem[semester_num];
  var x_offset = CLASS_WIDTH * rel_sem.length;
  rel_sem[rel_sem.length] = o;
  var sem_index = semester_num - 1;
  var y = sem_index * SEM_GAP_Y + FIRST_SEMESTER_Y;
  canvas_root.append('text')
    .attr({"x": MID_CLASS_X + x_offset,
           "y":  y + CLASS_TEXT_PUSH_Y,
           "class": "eebclass"})
    .text(o.title).attr({"text-anchor": "middle"});

}

var do_draw_classes = function() {
  canvas_root.append('text')
    .attr({"x":MID_CLASS_X, "y": CLASS_Y + 15,
           "font-size":"10pt", "fill": "grey",
           "text-anchor": "middle"})
    .text("Classes");

  var o;
  for (o of classes) {
    if (o.timing !== undefined) {
      add_class_obj(o);
    }
  }
}

$(document).ready(function() {
  do_parse_all_data(all_events);
  do_draw_timeline();
  do_draw_eeb_events();
  do_draw_classes();
});
</script>

</body>
</html>